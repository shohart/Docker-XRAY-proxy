services:
  xray:
    image: ghcr.io/xtls/xray-core:latest
    container_name: xray
    restart: unless-stopped
    network_mode: "host"
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./config:/etc/xray
      - ./data:/var/log/xray
      - ./scripts:/scripts:ro
    entrypoint:
      - /bin/sh
      - -ec
      - |
        chmod +x /scripts/*.sh 2>/dev/null || true
        /scripts/xray_watch.sh

  updater:
    image: python:3.12-alpine
    container_name: xray-updater
    restart: unless-stopped
    volumes:
      - ./config:/etc/xray
      - ./data:/var/log/xray
      - ./scripts:/scripts:ro
    entrypoint:
      - /bin/sh
      - -ec
      - |
        apk add --no-cache curl jq >/dev/null
        chmod +x /scripts/*.sh /scripts/*.py 2>/dev/null || true
        while true; do
          /scripts/update_subscription.sh || true
          sleep "$(( ${SUB_UPDATE_INTERVAL_MIN:-60} * 60 ))"
        done
    environment:
      XRAY_SUBSCRIPTION_URL: ${XRAY_SUBSCRIPTION_URL}
      SUB_UPDATE_INTERVAL_MIN: ${SUB_UPDATE_INTERVAL_MIN:-60}
      HTTP_PROXY_PORT: ${HTTP_PROXY_PORT:-3128}
      SOCKS_PROXY_PORT: ${SOCKS_PROXY_PORT:-1080}
