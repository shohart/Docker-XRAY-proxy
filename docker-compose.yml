services:
  xray:
    image: ghcr.io/xtls/xray-core:latest
    container_name: xray
    restart: unless-stopped
    network_mode: "host"
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./config:/etc/xray
      - ./data:/var/log/xray
    command: ["run", "-c", "/etc/xray/config.json"]

  updater:
    image: alpine:3.21
    container_name: xray-updater
    restart: unless-stopped
    volumes:
      - ./config:/etc/xray
      - ./data:/var/log/xray
      - ./scripts:/scripts:ro
    entrypoint:
      - /bin/sh
      - -ec
      - |
        apk add --no-cache curl jq >/dev/null
        while true; do
          /scripts/update_subscription.sh || true
          sleep "$(( ${SUB_UPDATE_INTERVAL_MIN:-60} * 60 ))"
        done
    environment:
      XRAY_SUBSCRIPTION_URL: ${XRAY_SUBSCRIPTION_URL}
      SUB_UPDATE_INTERVAL_MIN: ${SUB_UPDATE_INTERVAL_MIN:-60}
